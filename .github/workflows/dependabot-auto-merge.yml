name: Dependabot auto-merge
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read
  statuses: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.repository == 'tattiRA120/personalized-news-mailer' &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'github_actions')
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_URL: ${{github.event.pull_request.html_url}}
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: SetUp auto-merge
        id: auto-merge
        uses: dependabot/fetch-metadata@v2.4.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait 5 minutes for other checks to complete
        run: sleep 300

      - name: Check if all workflows have passed
        run: |
          MAX_RETRIES=6
          RETRY_INTERVAL=300  # 5分を秒で指定
          ATTEMPT=0
          CURRENT_WORKFLOW="Dependabot auto-merge"

          while [ $ATTEMPT -lt $MAX_RETRIES ]; do
            echo "Fetching PR status checks..."
            WORKFLOWS=$(gh pr view "$PR_URL" --json statusCheckRollup -q '.statusCheckRollup')

            # デバッグ: 各ステータスチェックの状態を出力
            echo "Debug: Current status of all checks:"
            WORKFLOW_STATUS=$(jq -r '[.[] | {name: (.workflowName // .name // .context), type: .["__typename"], status: .status, state: .state, conclusion: .conclusion}]' <<< "$WORKFLOWS")

            # 現在のワークフロー以外のすべてのチェックが成功したか確認
            all_passed=true
            while IFS= read -r check; do
              name=$(jq -r '.name' <<< "$check")
              type=$(jq -r '.type' <<< "$check")
              status=$(jq -r 'if .type == "CheckRun" then (if .status == "COMPLETED" then .conclusion else .status end) else .state end' <<< "$check")
              if [[ "$name" != "$CURRENT_WORKFLOW" && "$status" != "SUCCESS" ]]; then
                all_passed=false
                echo "Failed or Pending check: $name ($type) - Status: $status"
                break
              fi
            done < <(echo "$WORKFLOW_STATUS" | jq -c '.[]')

            if $all_passed; then
              echo "All other checks have passed"
              exit 0
            else
              echo "Some status checks have not passed. Attempt $((ATTEMPT + 1)) of $MAX_RETRIES."
              echo "Retrying in $RETRY_INTERVAL seconds..."
              sleep $RETRY_INTERVAL
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          echo "Failed to merge the PR after $MAX_RETRIES attempts due to failing status checks."
          exit 1
      - name: Auto-merge for Dependabot PRs
        run: gh pr merge --auto --merge "$PR_URL"
