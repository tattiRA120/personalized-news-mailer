name: Auto Label Safe Preview

on:
  workflow_run:
    workflows: ["CodeQL", "Dependency Review"]
    types:
      - completed

permissions:
  pull-requests: write
  actions: write

jobs:
  label-if-secure:
    name: Label Safe Preview
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: Check Security Workflows
        uses: actions/github-script@v8
        with:
          script: |
            const head_sha = context.payload.workflow_run.head_sha;
            console.log(`Checking workflows for commit: ${head_sha}`);

            // 1. Get all workflow runs for this commit
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: head_sha,
              status: 'success'
            });

            // 2. Check if we have success for both required workflows
            const requiredWorkflows = ['CodeQL', 'Dependency Review'];
            const finishedWorkflows = new Set(
              runs.data.workflow_runs
                .map(run => run.name)
              .map(name => {
                // Handle "Analyze (<language>)" format from CodeQL
                if (name.startsWith('Analyze (')) return 'CodeQL';
                return name;
              })
            );

            console.log('Successful workflows found:', Array.from(finishedWorkflows));

            const allPassed = requiredWorkflows.every(name => finishedWorkflows.has(name));

            if (allPassed) {
              console.log('All security checks passed. Proceeding to label PR.');
              
              // 3. Find the PR associated with this commit
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: head_sha,
              });

              if (prs.data.length > 0) {
                const pr = prs.data[0];
                console.log(`Found PR #${pr.number}: ${pr.title}`);
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['safe-to-preview']
                });
                console.log(`Added 'safe-to-preview' label to PR #${pr.number}`);

                // 4. Trigger auto-merge workflow
                try {
                  console.log(`Triggering auto-merge for PR #${pr.number}...`);
                  await github.rest.actions.createWorkflowDispatch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: 'dependabot-auto-merge.yml',
                    ref: 'main',
                    inputs: {
                      pr_url: pr.html_url
                    }
                  });
                  console.log('Auto-merge workflow triggered successfully.');
                } catch (error) {
                  console.error(`Failed to trigger auto-merge: ${error.message}`);
                  // Do not fail the workflow if triggering fails, as the label is already applied
                }

              } else {
                console.log('No PR found for this commit.');
              }
            } else {
              console.log('Not all security checks have passed yet.');
              console.log(`Missing: ${requiredWorkflows.filter(name => !finishedWorkflows.has(name)).join(', ')}`);
            }
