name: Preview Deploy

on:
  workflow_run:
    workflows: ["Preview Build"]
    types:
      - completed

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # We need to verify the PR label manually because workflow_run doesn't have it in context easily
      # and we don't want to run secrets on arbitrary PRs without a check.
      - name: Check for 'safe-to-preview' label
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id,
            });
            
            // workflow_run event doesn't give us the pull_requests array directly in payload sometimes, 
            // but the run object from API does.
            const prs = run.data.pull_requests;
            
            if (prs.length === 0) {
              console.log("No PR found associated with this run.");
              return; 
            }
            
            const prNumber = prs[0].number;
            console.log(`Checking matching PR #${prNumber} for labels...`);
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            const hasLabel = pr.data.labels.some(label => label.name === 'safe-to-preview');
            
            if (!hasLabel) {
              core.setFailed("PR does not have 'safe-to-preview' label. Skipping deployment.");
            } else {
              console.log("PR has 'safe-to-preview' label. Proceeding.");
            }

      - name: Download artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: preview-artifact
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (production only + dev for wrangler)
        run: npm ci

      - name: Start Wrangler Dev Server
        id: start-server
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "::error::CLOUDFLARE_API_TOKEN is missing or empty."
            exit 1
          fi

          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::CLOUDFLARE_ACCOUNT_ID is missing or empty."
            exit 1
          fi

          echo "Starting Wrangler Dev Server (Remote mode)..."
          
          # We need to manually recreate the wasm location if it was flattened or moved?
          # The artifact upload preserved directory structure, so it should be fine.
          ls -R
          
          echo "WORKER_BASE_URL=http://127.0.0.1:8787" > .dev.vars

          npx wrangler dev --remote --port 8787 --ip 127.0.0.1 > wrangler.log 2>&1 &
          PID=$!
          echo "Wrangler PID: $PID"
          
          echo "Waiting for server to be ready on port 8787..."
          timeout 120 bash -c 'until curl -s http://127.0.0.1:8787/personalized-education.html > /dev/null; do sleep 2; done' || (echo "Server failed to start within timeout" && echo "--- Wrangler Logs ---" && cat wrangler.log && echo "--- Curl Diagnostic ---" && curl -v http://127.0.0.1:8787/personalized-education.html && exit 1)
          
          echo "Server is ready!"
          echo "BASE_URL=http://127.0.0.1:8787" >> $GITHUB_ENV

      - name: Verify Endpoints
        id: verify
        uses: actions/github-script@v7
        env:
          BASE_URL: http://127.0.0.1:8787
        with:
          script: |
            const baseUrl = process.env.BASE_URL;
            console.log(`Starting verification against: ${baseUrl}`);

            // Helper to make requests
            const fetch = async (path, options = {}) => {
              const url = `${baseUrl}${path}`;
              console.log(`Fetching ${url}...`);
              // Use native fetch (available in Node.js 18+)
              return await global.fetch(url, options);
            };

            // Test 1: Static File
            // ----------------------------------------------------------------
            try {
              console.log('Test 1: GET /personalized-education.html');
              const res = await fetch('/personalized-education.html');
              if (!res.ok) throw new Error(`Failed to fetch static file: ${res.status} ${res.statusText}`);
              const text = await res.text();
              
              if (!text.includes('<title>パーソナライズド記事選択</title>')) {
                 console.log('Response body:', text.substring(0, 200) + '...');
                 throw new Error('Static file does not contain expected title');
              }
              console.log('✅ Static file verification passed');
            } catch (error) {
              console.error('❌ Static file verification failed:', error.message);
              core.setFailed('Static file verification failed');
            }

            // Test 2: Get Articles for Education
            // ----------------------------------------------------------------
            try {
              console.log('Test 2: GET /get-articles-for-education');
              const res = await fetch('/get-articles-for-education?userId=test-debug-user');
              if (!res.ok) throw new Error(`Failed to fetch articles: ${res.status} ${res.statusText}`);
              
              const json = await res.json();
              console.log('Response:', JSON.stringify(json).substring(0, 200) + '...');

              if (typeof json !== 'object' || json === null) throw new Error('Response is not an object');
              if (!Array.isArray(json.articles)) throw new Error('articles field is not an array');
              if (typeof json.score !== 'number') throw new Error('score field is not a number');
              
              console.log('✅ Articles API verification passed');
            } catch (error) {
               console.error('❌ Articles API verification failed:', error.message);
               core.setFailed('Articles API verification failed');
            }

            // Test 3: Get Dissimilar Articles
            // ----------------------------------------------------------------
            try {
              console.log('Test 3: GET /get-dissimilar-articles');
              const res = await fetch('/get-dissimilar-articles?userId=test-debug-user');
              if (!res.ok) throw new Error(`Failed to fetch dissimilar articles: ${res.status} ${res.statusText}`);
              
              const json = await res.json();
              console.log('Response:', JSON.stringify(json).substring(0, 200) + '...');

              if (!Array.isArray(json)) throw new Error('Response is not an array');
              
              console.log('✅ Dissimilar articles API verification passed');
            } catch (error) {
               console.error('❌ Dissimilar articles API verification failed:', error.message);
               core.setFailed('Dissimilar articles API verification failed');
            }

            // Test 4: Get Personalized Articles
            // ----------------------------------------------------------------
            try {
              console.log('Test 4: GET /get-personalized-articles');
              const res = await fetch('/get-personalized-articles?userId=test-debug-user&lambda=0.5');
              if (!res.ok) throw new Error(`Failed to fetch personalized articles: ${res.status} ${res.statusText}`);

              const json = await res.json();
              console.log('Response:', JSON.stringify(json).substring(0, 200) + '...');

              if (typeof json !== 'object' || json === null) throw new Error('Response is not an object');
              if (!Array.isArray(json.articles)) throw new Error('articles field is not an array');
              if (typeof json.score !== 'number') throw new Error('score field is not a number');
              if (json.score < 0 || json.score > 100) throw new Error(`score ${json.score} is out of range (0-100)`);

              console.log('✅ Personalized API verification passed');
            } catch (error) {
              console.error('❌ Personalized API verification failed:', error.message);
              core.setFailed('Personalized API verification failed');
            }

            // Test 5: Click Tracking
            // ----------------------------------------------------------------
            try {
              console.log('Test 5: GET /track-click');
              const redirectTarget = 'http://example.com/';
              const encodedUrl = encodeURIComponent(redirectTarget);
              const res = await fetch(`/track-click?userId=test-debug-user&articleId=test-link&redirectUrl=${encodedUrl}`, {
                redirect: 'manual'
              });
              
              if (res.status !== 302) throw new Error(`Expected 302 redirect, got ${res.status}`);
              const location = res.headers.get('Location');
              if (location !== redirectTarget) throw new Error(`Expected Location: ${redirectTarget}, got ${location}`);
              
              console.log('✅ Click tracking verification passed');
            } catch (error) {
              console.error('❌ Click tracking verification failed:', error.message);
              core.setFailed('Click tracking verification failed');
            }

            // Test 6: Single Feedback
            // ----------------------------------------------------------------
            try {
              console.log('Test 6: GET /track-feedback');
              const res = await fetch('/track-feedback?userId=test-debug-user&articleId=test-article-single&feedback=interested');
              if (!res.ok) throw new Error(`Failed to track feedback: ${res.status} ${res.statusText}`);

              console.log('✅ Single feedback verification passed');
            } catch (error) {
              console.error('❌ Single feedback verification failed:', error.message);
              core.setFailed('Single feedback verification failed');
            }

            // Test 7: Batch Feedback
            // ----------------------------------------------------------------
            try {
              console.log('Test 7: POST /track-feedback-batch');
              const payload = {
                userId: "test-debug-user",
                feedbackData: [{ articleId: "test-article-1", feedback: "interested" }],
                immediateUpdate: false
              };
              
              const res = await fetch('/track-feedback-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              
              if (!res.ok) throw new Error(`Failed to post feedback: ${res.status} ${res.statusText}`);
              const json = await res.json();
               console.log('Response:', JSON.stringify(json));
              
              if (!json) throw new Error('Empty response from feedback endpoint');

              console.log('✅ Batch feedback verification passed');
            } catch (error) {
              console.error('❌ Batch feedback verification failed:', error.message);
              core.setFailed('Batch feedback verification failed');
            }
