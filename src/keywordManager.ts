// src/keywordManager.ts

import { logInfo, logError, logWarning } from './logger';
import { ARTICLE_CATEGORIES } from './config'; // ARTICLE_CATEGORIES のみをインポート

interface CategoryKeywords {
    [key: string]: string[];
}

// デフォルトのカテゴリーキーワード辞書
const DEFAULT_CATEGORY_KEYWORDS: CategoryKeywords = {
    '政治': [
        '政治', '選挙', '国会', '内閣', '政党', '法案', '外交', '安全保障',
        '首相', '衆議院', '参議院', '政策', '公約', '官僚', 'ロビー',
        '改憲', '税制', '行政改革', '選挙戦', '発言', '議員', '野党',
        '与党', '地方自治', '知事', '市長', '政治資金', '地方議会', '憲法',
        '政治改革', '選挙速報', '選挙区', '投票率', '政治家', '政治団体',
        '石破', '自民党', '立憲民主党', '公明党', '共産党', '維新', '国民民主党',
        '解散総選挙', '補欠選挙', '統一地方選', 'サミット', 'G7', 'G20',
        '日米関係', '日中関係', '日韓関係', '防衛費', '少子化対策', '社会保障費',
        'デジタル庁', '規制改革', '地方創生', '財政健全化', '国際情勢', '国際会議'
    ],
    '経済': [
        '経済', '景気', '金融', '財政', '市場', '投資', '企業', '産業',
        '雇用', 'インフレ', 'デフレ', 'GDP', '経済成長', '株価', '為替',
        '為替相場', '金利', '証券', 'FX', 'リセッション', 'リストラ',
        '経常収支', '債務', '公債', '投資信託', '不動産', '資産', 'バブル',
        '消費', '物価', '消費税', '貿易', '輸出', '輸入', '金融政策',
        '日銀', '銀行', '決算', '為替動向', '経済指標', '失業率', '賃金',
        '円安', '円高', '物価上昇', '賃上げ', 'サプライチェーン', '半導体不足',
        'エネルギー価格', '原油価格', '食料価格', '中小企業', '大企業', 'ベンチャー企業',
        '経済対策', '財政出動', '金融緩和', '金融引き締め', '世界経済', '地域経済',
        'デジタル通貨', 'キャッシュレス', 'DX', 'グリーン投資', 'ESG投資', 'SDGs'
    ],
    'テクノロジー': [
        'テクノロジー', '技術', '開発', '研究', 'AI', '人工知能', 'IT',
        'ソフトウェア', 'ハードウェア', 'インターネット', '通信', '半導体',
        'クラウド', 'ビッグデータ', 'IoT', 'ロボット', '自動運転',
        'ブロックチェーン', '仮想通貨', 'VR', 'AR', '5G', '6G', 'ドローン',
        'サイバーセキュリティ', 'データサイエンス', 'プログラミング',
        'オープンソース', 'デジタルトランスフォーメーション', 'IT企業',
        'フィンテック', '量子コンピュータ', 'アルゴリズム', 'スマートシティ',
        'エッジコンピューティング', 'ディープラーニング', '機械学習',
        '生成AI', 'ChatGPT', '画像認識', '音声認識', '自然言語処理', 'RPA',
        'メタバース', 'Web3', 'NFT', 'DX推進', 'SaaS', 'PaaS', 'IaaS',
        'データセンター', 'スーパーコンピュータ', '半導体開発', '半導体製造',
        '次世代通信', '宇宙開発', '宇宙ビジネス', '衛星', 'ロケット', 'ISS',
        '月面探査', '火星探査', '宇宙旅行', 'バイオテクノロジー', 'ゲノム編集',
        '再生医療', '遺伝子治療', '新薬開発', '医療AI', '遠隔医療', 'スマート農業'
    ],
    'ビジネス': [
        'ビジネス', '経営', '戦略', 'マーケティング', 'スタートアップ',
        'M&A', '買収', '合併', '提携', '働き方', '起業', 'リーダーシップ',
        'ファイナンス', '会計', 'CFO', 'CEO', 'HR', '人事', 'コンサルティング',
        'ベンチャー', 'IPO', '株主', '証券', 'B2B', 'B2C', 'CSR',
        'サプライチェーン', '働き方改革', 'リモートワーク', 'テレワーク',
        '多国籍企業', '人材', '生産性', 'マネジメント', 'アウトソーシング',
        '経営戦略', 'ビジネスモデル', 'コーポレートガバナンス',
        '新規事業', '事業開発', 'イノベーション', 'DX', 'グローバル展開',
        '海外進出', '事業承継', '事業再生', '企業価値', 'ブランド戦略',
        '広報', 'IR', 'リスクマネジメント', 'コンプライアンス', '内部統制',
        '組織改革', '企業文化', 'ダイバーシティ', 'インクルージョン', 'SDGs経営',
        'ESG投資', 'サステナブル', 'シェアリングエコノミー', 'サブスクリプション',
        'プラットフォームビジネス', 'Eコマース', 'OMO', 'CRM', 'SFA', 'ERP'
    ],
    '科学': [
        '科学', '研究', '発見', '宇宙', '物理', '化学', '生物', '医学',
        '地学', '天文学', 'ノーベル', '遺伝子', 'DNA', 'クローン',
        'ナノテクノロジー', '量子', '細胞', '病理', '臨床', 'ワクチン',
        '疫学', '気象', '環境科学', '人工生命', '微生物', '生態学',
        '化石', '進化', 'プラズマ', 'ロボティクス', '臨床試験', '脳科学',
        'ニュートリション', '医学研究', 'バイオテクノロジー',
        '素粒子', '超伝導', '新素材', 'ゲノム', '遺伝子組み換え', 'iPS細胞',
        'ES細胞', '再生医療', '創薬', '感染症', 'パンデミック', 'ウイルス',
        '細菌', '免疫', '神経科学', '認知科学', '心理学', '考古学', '古生物学',
        '地球温暖化', '地震', '火山', '津波', '台風', '異常気象', '宇宙論',
        'ブラックホール', 'ダークマター', 'ダークエネルギー', '系外惑星', '宇宙望遠鏡'
    ],
    '環境': [
        '環境', '温暖化', '気候変動', '再生可能エネルギー', 'エコ', '汚染',
        '自然', '災害', 'サステナビリティ', 'リサイクル', 'プラスチック',
        '森林', '生物多様性', 'オゾン層', 'CO2', '脱炭素', 'ESG',
        '環境保護', 'エネルギー効率', '温室効果ガス', '洪水', '旱魃',
        '気象庁', '生態系', 'ビーチクリーン', 'エコロジー', '廃棄物',
        '環境影響評価', '環境政策', '有機農業', 'グリーンテクノロジー',
        'SDGs', 'パリ協定', 'COP', 'カーボンニュートラル', 'ゼロエミッション',
        '循環型社会', '省エネ', '節電', '水資源', '海洋汚染', '大気汚染',
        '土壌汚染', '絶滅危惧種', '国立公園', '自然保護区', '野生動物',
        '森林破壊', '砂漠化', '異常気象', '自然災害', '防災対策', '減災',
        '環境教育', '環境ビジネス', 'グリーンファイナンス', 'エシカル消費'
    ],
    '社会': [
        '社会', '問題', '事件', '事故', '裁判', '教育', '医療', '福祉',
        '労働', '人権', 'ジェンダー', '少子化', '高齢化', '移民',
        '雇用問題', '失業', 'ブラック企業', '貧困', '児童虐待', 'DV',
        'ハラスメント', 'LGBT', '差別', '在宅医療', '地方創生', '社会保障',
        '介護', '年金', '保育', '教育改革', '過労', '就職', '地域格差',
        '児童福祉', '性暴力', 'いじめ', 'NPO', 'ボランティア',
        '地域社会', 'コミュニティ', '地域活性化', '地方移住', 'Uターン', 'Iターン',
        '子育て支援', '待機児童', '学力格差', '不登校', 'いじめ問題', '大学入試',
        '奨学金', '医療費', '健康保険', '国民皆保険', '地域医療', '医師不足',
        '看護師不足', '介護保険', '介護施設', '高齢者施設', '認知症', '終活',
        '成年後見人', '生活保護', 'ホームレス', 'フードロス', '食品ロス',
        '消費者問題', '詐欺', '特殊詐欺', 'サイバー犯罪', '少年犯罪', '再犯防止',
        '刑務所', '更生保護', '司法制度', '弁護士', '検察官', '警察官', '消防士',
        '災害ボランティア', '地域防災', '避難所', '復興支援', '国際協力', 'ODA'
    ],
    '文化': [
        '文化', '芸術', '文学', '音楽', '映画', '美術', '演劇', '歴史',
        '哲学', '宗教', '伝統', '習慣', '祭り', '建築', 'デザイン',
        'ファッション', '美学', '写真', '演出', 'オペラ', '書道',
        '陶芸', 'アートフェス', '民俗学', '近代文学', '芸術祭',
        'クリエイティブ', '舞踊', '茶道', '華道', 'カンヌ映画祭', '映画祭',
        '世界遺産', '無形文化遺産', '国宝', '重要文化財', '博物館', '美術館',
        '図書館', '古文書', '考古学', '民芸品', '工芸品', '伝統工芸',
        'ポップカルチャー', 'アニメ文化', '漫画文化', 'ゲーム文化', 'コスプレ',
        'サブカルチャー', 'ストリートアート', 'グラフィティ', '現代アート',
        'クラシック音楽', 'ジャズ', 'ロック', 'ポップス', 'ヒップホップ',
        '演歌', '歌舞伎', '能', '狂言', '文楽', '落語', '漫才', 'コント',
        '小説', '詩', '俳句', '短歌', 'エッセイ', '評論', 'ノンフィクション',
        '思想', '倫理', '道徳', '神話', '伝説', '民話', 'おとぎ話', '昔話'
    ],
    'エンタメ': [
        'エンタメ', '芸能', '映画', '音楽', 'テレビ', 'ドラマ', '俳優',
        '女優', 'アーティスト', 'アイドル', 'K-POP', 'ゲーム', 'アニメ',
        '漫画', '芸人', 'コンサート', 'フェス', '配信', 'YouTuber',
        'SNS', 'バラエティ', '舞台', 'ミュージカル', '声優', 'オンライン配信',
        'ドキュメンタリー', 'ラジオ', '劇場', 'ライブ', 'エンターテイナー',
        'ハリウッド', '邦画', '洋画', 'アニメ映画', 'ドキュメンタリー映画',
        'アカデミー賞', 'ゴールデングローブ賞', 'グラミー賞', '紅白歌合戦',
        'お笑い', '漫才コンテスト', 'コント番組', 'リアリティ番組', 'クイズ番組',
        '情報番組', 'ニュース番組', 'スポーツ番組', '音楽番組', '歌番組',
        '声優イベント', 'アニメイベント', 'ゲームイベント', 'コミケ', '同人誌',
        'VTuber', 'eスポーツ大会', 'ストリーマー', 'インフルエンサー', 'TikTok',
        'Instagram', 'X', 'YouTube', 'Netflix', 'Amazon Prime Video', 'Hulu',
        'Disney+', 'U-NEXT', 'DAZN', 'ABEMA', 'TVer', 'FOD', 'Paravi'
    ],
    'スポーツ': [
        'スポーツ', '野球', 'サッカー', 'バスケ', 'テニス', 'ゴルフ',
        'オリンピック', '選手', '試合', '大会', 'Jリーグ', 'プロ野球',
        '高校野球', 'サッカーW杯', '野球中継', 'ラグビー', 'F1',
        '格闘技', '相撲', 'ボクシング', '柔道', '水泳', '陸上',
        '自転車', 'スキー', 'スノーボード', 'マラソン', 'トーナメント',
        '競泳', '卓球', 'バレーボール', 'バレエ', 'eスポーツ', 'F1', 'モナコGP',
        'モータースポーツ', '予選', '決勝', 'ドライバー', 'チーム',
        'プロレス', 'K-1', 'RIZIN', '大相撲', '幕内', '横綱', '大関',
        '甲子園', '箱根駅伝', '東京マラソン', '世界陸上', '世界水泳',
        'テニス四大大会', 'マスターズ', '全米オープン', '全仏オープン', '全英オープン',
        'NBA', 'Bリーグ', 'Vリーグ', 'トップリーグ', 'スーパーラグビー',
        'WBC', 'ワールドカップ', 'アジアカップ', 'チャンピオンズリーグ',
        'プレミアリーグ', 'ラ・リーガ', 'セリエA', 'ブンデスリーガ', 'リーグ・アン',
        'MLB', 'NPB', 'JLPGA', 'PGA', 'LPGA', 'ATP', 'WTA', 'FIFA', 'IOC'
    ],
    '国際': [
        '国際', '世界', '海外', '外交', '紛争', '条約', '国連', 'EU',
        'アメリカ', '中国', '韓国', 'ロシア', '地政学', 'グローバル',
        '米中関係', '貿易戦争', '国際法', 'ヨーロッパ', '中東', 'アフリカ',
        'ASEAN', 'G7', 'G20', '国際会議', '国際援助', '国際協力',
        '難民', '領土問題', '多国間', '国際機関', '北朝鮮',
        'ウクライナ', 'ガザ', '中東情勢', 'ロシア・ウクライナ戦争', 'パレスチナ',
        'イスラエル', 'イラン', 'シリア', 'イエメン', 'アフガニスタン', 'ミャンマー',
        '台湾有事', '南シナ海', '東シナ海', '北極圏', '南極', '宇宙空間',
        '国際連合', '世界保健機関', 'WHO', '世界貿易機関', 'WTO', '国際通貨基金',
        'IMF', '世界銀行', 'WB', '国際刑事裁判所', 'ICC', '国際司法裁判所', 'ICJ',
        'NATO', 'BRICS', '上海協力機構', 'SCO', 'APEC', 'TPP', 'RCEP',
        '人道支援', '平和維持活動', 'PKO', '核兵器', '軍縮', 'テロ', 'サイバー攻撃',
        '国際犯罪', '人身売買', '麻薬密輸', '国際テロ組織', '国境管理', 'ビザ', 'パスポート'
    ],
    '国内': [
        '国内', '日本', '地域', '地方', '行政', '地方自治体',
        '都市開発', '交通', '鉄道', '道路', '震災', '洪水', '自治体',
        '防災', '地方創生', '地域振興', '住民投票', '地域経済',
        '都道府県', '市町村', '過疎化', '高齢化社会', '人口減少', '地方活性化',
        '観光振興', 'インバウンド', '地域ブランド', '特産品', '伝統文化',
        '公共交通', '高速道路', '新幹線', '空港', '港湾', '物流',
        '地震対策', '津波対策', '火山噴火', '土砂災害', '避難訓練', 'ハザードマップ',
        '復興支援', '被災地', '災害ボランティア', '医療提供体制', '介護サービス',
        '教育制度', '学校教育', '生涯学習', '地域医療', '地域福祉', '地域包括ケア',
        '空き家問題', '耕作放棄地', '農業振興', '漁業振興', '林業振興', '中山間地域',
        '離島振興', '少子化対策', '子育て支援', '待機児童問題', '働き方改革',
        'テレワーク推進', 'デジタル化推進', '行政サービス', 'マイナンバー', 'DX推進'
    ],
    'その他': []
};

// KV Namespace の型定義
export interface EnvWithKeywordsKV {
    CATEGORY_KEYWORDS_KV: KVNamespace;
}

const KEYWORDS_KV_KEY = 'category_keywords';

/**
 * KVからカテゴリーキーワード辞書を読み込む
 * @param env KV Namespace バインディングを含む環境変数
 * @returns カテゴリーキーワード辞書
 */
export async function getCategoryKeywords(env: EnvWithKeywordsKV): Promise<CategoryKeywords> {
    try {
        const cachedKeywords = await env.CATEGORY_KEYWORDS_KV.get(KEYWORDS_KV_KEY, { type: 'json' });
        if (cachedKeywords) {
            logInfo('Loaded category keywords from KV.');
            return cachedKeywords as CategoryKeywords;
        }
    } catch (error) {
        logError('Error loading category keywords from KV. Using default keywords.', error);
    }

    // KVに存在しない場合、またはエラーが発生した場合はデフォルトのキーワードを使用し、KVに保存
    logInfo('Category keywords not found in KV or failed to load. Initializing with default keywords.');
    await saveCategoryKeywords(DEFAULT_CATEGORY_KEYWORDS, env);
    return DEFAULT_CATEGORY_KEYWORDS;
}

/**
 * カテゴリーキーワード辞書をKVに保存する
 * @param keywords 保存するカテゴリーキーワード辞書
 * @param env KV Namespace バインディングを含む環境変数
 */
export async function saveCategoryKeywords(keywords: CategoryKeywords, env: EnvWithKeywordsKV): Promise<void> {
    try {
        await env.CATEGORY_KEYWORDS_KV.put(KEYWORDS_KV_KEY, JSON.stringify(keywords));
        logInfo('Saved category keywords to KV.');
    } catch (error) {
        logError('Error saving category keywords to KV.', error);
    }
}

/**
 * カテゴリーキーワード辞書を更新する（新しいキーワードを追加）
 * @param category 更新対象のカテゴリー
 * @param newKeywords 追加する新しいキーワードの配列
 * @param env KV Namespace バインディングを含む環境変数
 */
export async function updateCategoryKeywords(category: string, newKeywords: string[], env: EnvWithKeywordsKV): Promise<void> {
    if (!ARTICLE_CATEGORIES.includes(category)) {
        logWarning(`Attempted to update keywords for invalid category: ${category}`);
        return;
    }

    const currentKeywords = await getCategoryKeywords(env);
    const existingKeywords = new Set(currentKeywords[category] || []);
    let updated = false;

    newKeywords.forEach(kw => {
        const lowerKw = kw.toLowerCase();
        if (!existingKeywords.has(lowerKw)) {
            existingKeywords.add(lowerKw);
            updated = true;
        }
    });

    if (updated) {
        currentKeywords[category] = Array.from(existingKeywords);
        await saveCategoryKeywords(currentKeywords, env);
        logInfo(`Updated keywords for category '${category}'. Added ${newKeywords.length} new keywords.`);
    } else {
        logInfo(`No new keywords to add for category '${category}'.`);
    }
}

/**
 * 記事のタイトルとサマリーからキーワード候補を抽出する（簡易版）
 * TODO: より高度なキーワード抽出（TF-IDF, N-gram, 形態素解析など）を検討
 * @param text 記事のタイトルまたはサマリー
 * @returns 抽出されたキーワード候補の配列
 */
export function extractKeywordsFromText(text: string): string[] {
    // 日本語の簡易的なキーワード抽出
    // 現状はスペース区切りで単語を抽出し、短い単語や一般的な単語を除外
    const words = text.toLowerCase().split(/[\s.,;!?"'()\[\]{}<>“”‘’—\-ー、。「」『』（）？！]/).filter(Boolean);
    const stopWords = new Set([
        'の', 'に', 'を', 'が', 'は', 'と', 'へ', 'から', 'まで', 'で', 'も', 'や', 'など', 'こと', 'もの', 'ため',
        'れる', 'する', 'いる', 'ある', 'なる', 'よう', 'これ', 'それ', 'あれ', 'この', 'その', 'あの', 'です', 'ます',
        'だ', 'である', 'ました', 'でしょう', 'だろう', 'ません', 'ない'
    ]);

    // 短すぎる単語やストップワードを除外
    const filteredWords = words.filter(word => word.length > 1 && !stopWords.has(word));

    // 重複を排除して返す
    return Array.from(new Set(filteredWords));
}
